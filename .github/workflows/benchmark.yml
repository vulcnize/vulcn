name: Benchmark

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      skip_docker:
        description: "Skip Docker targets (DVWA, WebGoat)"
        type: boolean
        default: true
      publish:
        description: "Publish results to vulcn.dev"
        type: boolean
        default: true

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm build

      - name: Install Playwright browsers
        run: npx playwright install chromium

      # Start DVWA manually instead of as a service â€” its health check
      # returns 302 on / which makes GH Actions services mark it unhealthy
      # and abort the entire job. Running it manually lets us handle failure gracefully.
      - name: Start DVWA container
        if: github.event_name == 'release' || inputs.skip_docker != true
        run: |
          docker run -d \
            --name dvwa \
            -p 4280:80 \
            vulnerables/web-dvwa

          # Wait for DVWA to be ready (accepts 302 redirects as success)
          echo "Waiting for DVWA to start..."
          for i in $(seq 1 30); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:4280/ | grep -qE "^(200|302|301)$"; then
              echo "DVWA is ready!"
              break
            fi
            echo "  Attempt $i/30 â€” waiting 2s..."
            sleep 2
          done

          # Verify it's actually up
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:4280/)
          echo "DVWA status: $STATUS"
        continue-on-error: true

      - name: Run benchmarks (release)
        if: github.event_name == 'release'
        run: pnpm tsx benchmarks/run.ts --publish
        env:
          API_SECRET: ${{ secrets.API_SECRET }}
          BENCHMARK_API_URL: https://vulcn.dev/api/benchmarks

      - name: Run benchmarks (manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          ARGS=""
          if [ "${{ inputs.skip_docker }}" = "true" ]; then
            ARGS="$ARGS --skip-docker"
          fi
          if [ "${{ inputs.publish }}" = "true" ]; then
            ARGS="$ARGS --publish"
          fi
          pnpm tsx benchmarks/run.ts $ARGS
        env:
          API_SECRET: ${{ secrets.API_SECRET }}
          BENCHMARK_API_URL: https://vulcn.dev/api/benchmarks

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: benchmarks/results/
          retention-days: 90

      - name: Comment on release
        if: github.event_name == 'release'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Find the latest results file
            const dir = './benchmarks/results/';
            if (!fs.existsSync(dir)) return;

            const files = fs.readdirSync(dir);
            const jsonFile = files.find(f => f.endsWith('.json') && !f.startsWith('sessions'));
            if (!jsonFile) return;

            const results = JSON.parse(fs.readFileSync(`${dir}${jsonFile}`, 'utf-8'));

            const body = `## ðŸ“Š Benchmark Results â€” v${results.version}

            | Metric | Value |
            |--------|-------|
            | **Youden Score** | ${results.score.toFixed(3)} |
            | **TPR** (sensitivity) | ${(results.tpr * 100).toFixed(1)}% |
            | **FPR** (false alarms) | ${(results.fpr * 100).toFixed(1)}% |
            | **Known Vulns** | ${results.summary.totalKnown} |
            | **Detected** | ${results.summary.detected} |
            | **Missed** | ${results.summary.missed} |
            | **False Positives** | ${results.summary.falsePositives} |
            | **Duration** | ${(results.duration / 1000).toFixed(1)}s |

            ### Per-Target Breakdown

            | Target | TPR | FPR | Youden | Known | Detected |
            |--------|-----|-----|--------|-------|----------|
            ${results.targets.map(t =>
              `| ${t.name} | ${(t.tpr * 100).toFixed(0)}% | ${(t.fpr * 100).toFixed(0)}% | ${t.score.toFixed(3)} | ${t.knownVulns} | ${t.detected} |`
            ).join('\n')}

            [View full results on vulcn.dev/benchmarks](https://vulcn.dev/benchmarks)`;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: context.payload.release.body + '\n\n' + body,
            });

      - name: Cleanup DVWA
        if: always()
        run: docker rm -f dvwa 2>/dev/null || true
